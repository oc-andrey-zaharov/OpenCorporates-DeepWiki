# syntax=docker/dockerfile:1-labs

FROM python:3.11-slim AS py_deps
WORKDIR /api
COPY pyproject.toml .
COPY poetry.lock .
RUN python -m pip install poetry==2.0.1 --no-cache-dir && \
    poetry config virtualenvs.create true --local && \
    poetry config virtualenvs.in-project true --local && \
    poetry config virtualenvs.options.always-copy --local true && \
    POETRY_MAX_WORKERS=10 poetry install --no-interaction --no-ansi --only main && \
    poetry cache clear --all .

FROM python:3.11-slim AS ollama_base
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

# ARG TARGETARCH allows building for arm64/amd64
ARG TARGETARCH=arm64
RUN OLLAMA_ARCH="" && \
    if [ "$TARGETARCH" = "arm64" ]; then \
        OLLAMA_ARCH="arm64"; \
    elif [ "$TARGETARCH" = "amd64" ]; then \
        OLLAMA_ARCH="amd64"; \
    else \
        echo "Unsupported architecture '$TARGETARCH'" >&2 && exit 1; \
    fi && \
    curl -L "https://ollama.com/download/ollama-linux-${OLLAMA_ARCH}.tgz" -o ollama.tgz && \
    tar -C /usr -xzf ollama.tgz && \
    rm ollama.tgz

RUN ollama serve > /dev/null 2>&1 & \
    sleep 20 && \
    ollama pull nomic-embed-text && \
    ollama pull qwen3:1.7b

FROM python:3.11-slim
WORKDIR /app

# Base system deps for git + curl
RUN apt-get update && apt-get install -y \
    curl \
    git \
    ca-certificates \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

ENV PATH="/opt/venv/bin:$PATH"

# Copy Python environment and application
COPY --from=py_deps /api/.venv /opt/venv
COPY api/ ./api/

# Copy Ollama binary/model cache
COPY --from=ollama_base /usr/bin/ollama /usr/local/bin/
COPY --from=ollama_base /root/.ollama /root/.ollama

EXPOSE ${PORT:-8001}

RUN echo '#!/bin/bash\n\
# Start Ollama in background\n\
ollama serve > /dev/null 2>&1 &\n\
\n\
# Load env vars from .env if present\n\
if [ -f .env ]; then\n\
  export $(grep -v "^#" .env | xargs -r)\n\
fi\n\
\n\
if [ -z "$OPENAI_API_KEY" ] || [ -z "$GOOGLE_API_KEY" ]; then\n\
  echo "Warning: OPENAI_API_KEY and/or GOOGLE_API_KEY not set." >&2\n\
fi\n\
\n\
python -m api.server.main --port ${PORT:-8001}\n\
' > /app/start.sh && chmod +x /app/start.sh

ENV PORT=8001
ENV SERVER_BASE_URL=http://localhost:${PORT:-8001}

RUN touch .env

CMD ["/app/start.sh"]
